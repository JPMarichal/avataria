# Avatar HTML Filter Fix - Solución al avatar roto tras remover avatar actual

## Problema

Después de implementar los fixes en PRs #65 y #67:
- ✅ La eliminación de avatars de la Media Library funcionaba correctamente
- ✅ Los filtros `filter_avatar_url()` y `filter_avatar_data()` generaban correctamente SVG con iniciales
- ❌ **PERO**: `get_avatar()` seguía devolviendo HTML con imagen rota: `<img src='' srcset=' 2x' />`

## Causa Raíz

WordPress llama a `get_avatar_url()` dos veces:
1. Una vez para el tamaño normal
2. Una vez para el tamaño `* 2` (retina display) → srcset

Sin embargo, el HTML final generado por `get_avatar()` no aplicaba correctamente los resultados de estos filtros cuando no había avatar local, resultando en atributos `src` y `srcset` vacíos o mal formados (como `' 2x'`).

### Diagnóstico

Ejecutando el script de debug `debug-avatar-fallback.php`:

```
--- Testing filter_avatar_url() ---
✓ SUCCESS: URL was replaced with SVG data URL!

--- Testing filter_avatar_data() ---
✓ SUCCESS: filter_avatar_data() also working correctly!

=== Final Test: get_avatar() ===
Avatar HTML: <img alt='' src='' srcset=' 2x' class='avatar' />
❌ FAIL: get_avatar() is still returning broken image with '2x'.
```

Los filtros individuales funcionaban, pero el HTML final no.

## Solución Implementada

Se agregó un **tercer filtro** para interceptar el HTML completo generado por WordPress.

### Cambios en `src/AvatarSteward/Core/AvatarHandler.php`

#### 1. Registro del nuevo filtro en `init()`

```php
public function init(): void {
    if ( function_exists( 'add_filter' ) ) {
        add_filter( 'pre_get_avatar_data', array( $this, 'filter_avatar_data' ), 10, 2 );
        add_filter( 'get_avatar_url', array( $this, 'filter_avatar_url' ), 10, 3 );
        add_filter( 'get_avatar', array( $this, 'filter_avatar_html' ), 10, 6 ); // NUEVO
    }
}
```

#### 2. Nuevo método `filter_avatar_html()`

```php
/**
 * Filter avatar HTML to ensure proper avatar display.
 *
 * This filter is called after WordPress generates the avatar HTML.
 * It ensures that when we use initials-based avatars, the HTML
 * attributes are properly populated.
 *
 * @param string $avatar         The avatar HTML markup.
 * @param mixed  $id_or_email    The Gravatar to retrieve.
 * @param int    $size           Avatar size in pixels.
 * @param string $default_avatar Default avatar URL (unused).
 * @param string $alt_text       Alt text for the avatar (unused).
 * @param array  $avatar_args    Additional arguments (unused).
 * @return string Modified avatar HTML.
 */
public function filter_avatar_html( string $avatar, $id_or_email, int $size, string $default_avatar, string $alt_text, array $avatar_args ): string {
    // If the avatar HTML has empty src attribute, try to fix it.
    if ( strpos( $avatar, "src=''" ) !== false || strpos( $avatar, 'src=""' ) !== false || strpos( $avatar, "src=' '" ) !== false || strpos( $avatar, 'src=" "' ) !== false ) {
        $user_id = $this->get_user_id_from_identifier( $id_or_email );

        if ( $user_id ) {
            // Get the avatar URL (with fallback to initials).
            $avatar_url = $this->filter_avatar_url( '', $id_or_email, array( 'size' => $size ) );

            if ( $avatar_url && strpos( $avatar_url, 'data:image/svg+xml' ) === 0 ) {
                // For data URLs (SVG), we don't use esc_url as it can break the encoding.
                // The URL is already safely generated by our generator.
                $safe_url = htmlspecialchars( $avatar_url, ENT_QUOTES, 'UTF-8' );
                
                // Replace empty src with the generated SVG URL.
                $avatar = str_replace( "src=''", "src='" . $safe_url . "'", $avatar );
                $avatar = str_replace( 'src=""', 'src="' . $safe_url . '"', $avatar );
                $avatar = str_replace( "src=' '", "src='" . $safe_url . "'", $avatar );
                $avatar = str_replace( 'src=" "', 'src="' . $safe_url . '"', $avatar );

                // Remove or fix the srcset attribute (SVG doesn't need retina versions).
                $avatar = preg_replace( "/\s+srcset=['\"][^'\"]*['\"]/", '', $avatar );
            }
        }
    }

    return $avatar;
}
```

### Lógica del Fix

1. **Detecta HTML con src vacío**: Busca patrones como `src=''`, `src=""`, `src=' '`, `src=" "`
2. **Obtiene el avatar URL correcto**: Reutiliza `filter_avatar_url()` que ya tiene la lógica de fallback a iniciales
3. **Valida que sea SVG**: Solo procesa si es un data URL SVG
4. **Escapa correctamente**: Usa `htmlspecialchars()` en lugar de `esc_url()` para no romper el data URL
5. **Reemplaza src vacío**: Sustituye el src vacío con el SVG generado
6. **Elimina srcset roto**: Remueve el atributo srcset que contiene `' 2x'` inválido

## Resultado

### Antes del Fix ❌

```html
<img alt='' src='' srcset=' 2x' class='avatar avatar-96 photo' height='96' width='96' />
```

### Después del Fix ✅

```html
<img alt='' 
     src='data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2296%22%20height%3D%2296%22%20viewBox%3D%220%200%2096%2096%22%3E%3Crect%20width%3D%2296%22%20height%3D%2296%22%20fill%3D%22%23e74c3c%22%2F%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20font-family%3D%22Arial%2C%20Helvetica%2C%20sans-serif%22%20font-size%3D%2240%22%20fill%3D%22%23ffffff%22%20text-anchor%3D%22middle%22%20dy%3D%22.35em%22%3EAD%3C%2Ftext%3E%3C%2Fsvg%3E' 
     class='avatar avatar-96 photo' 
     height='96' 
     width='96' 
     loading='lazy' 
     decoding='async'/>
```

El avatar ahora muestra correctamente las iniciales del usuario (ej. "AD" para "admin") en un círculo de color.

## Verificación

### Script de Debug

Se creó `debug-avatar-fallback.php` para diagnosticar el problema:

```bash
docker exec avatarsteward_wordpress php /var/www/html/wp-content/plugins/avatar-steward/debug-avatar-fallback.php
```

Resultado:
```
✓ Generator is properly injected into AvatarHandler.
✓ SUCCESS: URL was replaced with SVG data URL!
✓ SUCCESS: filter_avatar_data() also working correctly!
✓ SUCCESS: get_avatar() is using the SVG data URL!
   Everything is working correctly.
```

### Página de Prueba Visual

Se creó `test-avatar-display.php` para verificación visual:

```
http://localhost:8080/wp-content/plugins/avatar-steward/test-avatar-display.php
```

### Verificación en Producción

1. Ir a perfil de usuario: `http://localhost:8080/wp-admin/profile.php`
2. Si hay avatar actual, removerlo marcando "Remove current avatar" y guardar
3. Verificar que se muestra avatar con iniciales, sin imagen rota

## Archivos Modificados

- `src/AvatarSteward/Core/AvatarHandler.php` (+45 líneas)
  - Agregado filtro `get_avatar` en `init()`
  - Nuevo método `filter_avatar_html()`

## Tests

Los tests unitarios existentes siguen pasando. El fix no rompe funcionalidad previa:

```bash
composer test
```

## Impacto

- **Performance**: Mínimo. Solo ejecuta el fix cuando detecta `src` vacío
- **Compatibilidad**: 100% compatible con código existente
- **WordPress**: Usa hooks estándar de WordPress sin modificar core

## Relación con Issues/PRs

- **Resuelve**: Issue #66 (Avatar por defecto genera URL inválida)
- **Complementa**: PR #65 (Eliminación de Media Library) y PR #67 (Fallback a iniciales)
- **Relacionado**: Issue #64 (Remover avatar genera imagen rota)

## Próximos Pasos

- [ ] Agregar tests unitarios específicos para `filter_avatar_html()`
- [ ] Verificar comportamiento con múltiples tamaños de avatar
- [ ] Documentar en README.md el comportamiento del avatar por defecto

---

**Autor**: GitHub Copilot  
**Fecha**: 20 de octubre de 2025  
**Estado**: ✅ Implementado y verificado
